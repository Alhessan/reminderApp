<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
      <ion-back-button defaultHref="/task-list"></ion-back-button>
    </ion-buttons>
    <ion-title>Notification Methods</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-list>
    <ion-item-group>
      <ion-item-divider>
        <ion-label>
          <h2>Available Notification Methods</h2>
          <p>Select up to 3 methods</p>
        </ion-label>
      </ion-item-divider>

      <form [formGroup]="notificationForm">
        <ion-item *ngFor="let type of notificationTypes$ | async">
          <ion-icon [name]="type.icon" slot="start" [style.color]="isTypeEnabled(type.key) ? type.color : 'var(--ion-color-medium)'"></ion-icon>
          <ion-label>
            <h2>{{ type.name }}</h2>
            <p>{{ type.description }}</p>
          </ion-label>
          <ion-toggle 
            [checked]="isTypeEnabled(type.key)"
            (ionChange)="onToggleChange(type)"
            [disabled]="getEnabledCount() >= 3 && !isTypeEnabled(type.key)">
          </ion-toggle>
        </ion-item>

        <!-- Additional Fields for Enabled Types -->
        <div class="additional-fields" *ngIf="showAdditionalFields">
          <ion-item-divider>
            <ion-label>Additional Information Required</ion-label>
          </ion-item-divider>

          <!-- Email Field -->
          <ion-item *ngIf="isTypeEnabled('email')">
            <ion-label position="stacked">Email Address</ion-label>
            <ion-input 
              type="email" 
              formControlName="emailAddress"
              placeholder="Enter your email address">
            </ion-input>
            <ion-note slot="error" *ngIf="notificationForm.get('emailAddress')?.touched && notificationForm.get('emailAddress')?.errors">
              {{ getValidationError('email') }}
            </ion-note>
          </ion-item>

          <!-- SMS Field -->
          <ion-item *ngIf="isTypeEnabled('sms')">
            <ion-label position="stacked">Phone Number</ion-label>
            <ion-input 
              type="tel" 
              formControlName="phoneNumber"
              placeholder="Enter your phone number">
            </ion-input>
            <ion-note slot="error" *ngIf="notificationForm.get('phoneNumber')?.touched && notificationForm.get('phoneNumber')?.errors">
              {{ getValidationError('sms') }}
            </ion-note>
          </ion-item>

          <!-- WhatsApp Field -->
          <ion-item *ngIf="isTypeEnabled('whatsapp')">
            <ion-label position="stacked">WhatsApp Number</ion-label>
            <ion-input 
              type="tel" 
              formControlName="whatsappNumber"
              placeholder="Enter your WhatsApp number">
            </ion-input>
            <ion-note slot="error" *ngIf="notificationForm.get('whatsappNumber')?.touched && notificationForm.get('whatsappNumber')?.errors">
              {{ getValidationError('whatsapp') }}
            </ion-note>
          </ion-item>

          <!-- Telegram Field -->
          <ion-item *ngIf="isTypeEnabled('telegram')">
            <ion-label position="stacked">Telegram Username</ion-label>
            <ion-input 
              type="text" 
              formControlName="telegramUsername"
              placeholder="Enter your Telegram username">
            </ion-input>
            <ion-note slot="error" *ngIf="notificationForm.get('telegramUsername')?.touched && notificationForm.get('telegramUsername')?.errors">
              {{ getValidationError('telegram') }}
            </ion-note>
          </ion-item>
        </div>
      </form>
    </ion-item-group>
  </ion-list>

  <!-- Save Button -->
  <ion-button 
    expand="block" 
    class="ion-margin" 
    (click)="saveSettings()"
    [disabled]="notificationForm.invalid && showAdditionalFields">
    <ion-icon name="save-outline" slot="start"></ion-icon>
    Save Settings
  </ion-button>

  <!-- Information Card - Now outside the form -->
  <ion-card class="ion-margin">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="information-circle-outline" color="primary"></ion-icon>
        About Notification Methods
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>Enable up to three notification methods for your routines. Some methods require additional information:</p>
      <ion-list>
        <ion-item lines="none">
          <ion-icon name="notifications-outline" slot="start" color="success"></ion-icon>
          <ion-label>
            <h3>Push Notifications</h3>
            <p>Instant notifications on your device</p>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Email Notifications</h3>
            <p>Get reminders in your inbox</p>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-icon name="chatbox-outline" slot="start" color="tertiary"></ion-icon>
          <ion-label>
            <h3>SMS Notifications</h3>
            <p>Text message reminders</p>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-icon name="logo-whatsapp" slot="start" style="color: #25D366"></ion-icon>
          <ion-label>
            <h3>WhatsApp Notifications</h3>
            <p>Get reminders via WhatsApp</p>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-icon name="paper-plane-outline" slot="start" style="color: #0088cc"></ion-icon>
          <ion-label>
            <h3>Telegram Notifications</h3>
            <p>Receive reminders on Telegram</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>
</ion-content> 